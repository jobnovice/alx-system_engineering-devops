#!/usr/bin/env bash

nginx_conf='/etc/nginx/sites-available/default'

new_conf="location /redirect_me {
    rewrite ^/redirect_me(.*) http://www.google.com permanent;
}

location / {
    try_files \$uri \$uri/ =404;
}"

# Use awk to append the new_conf after the 'location / {' line
awk -v new_conf="$new_conf" '/location \/ {/{print; print new_conf; next}1' $nginx_conf > $nginx_conf.tmp

# Check if the temporary file was created successfully
if [ -e $nginx_conf.tmp ]; then
    # Replace the original configuration file with the modified one
    mv $nginx_conf.tmp $nginx_conf

    # Test the Nginx configuration
    nginx -t

    # If the configuration test is successful, restart Nginx to apply the changes
    if [ $? -eq 0 ]; then
        service nginx restart
    else
        echo "Nginx configuration test failed. Check the error messages above."
    fi
else
    echo "Failed to create the temporary file."
fi
